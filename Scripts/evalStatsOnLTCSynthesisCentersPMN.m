rootPath = "C:\Users\nicho\Desktop\For Angie\2019 PMN REVISIONS ClusDoC\";

fprintf("c5a 5LO CPLA2\n");

getPointsInCluster(rootPath + "m1 c5a\results c5a 5lo561 cpla2647\", 5, 5);
getPointsInCluster(rootPath + "m1 c5a\results c5a 5lo561 cpla2648\", 5, 5);
getPointsInCluster(rootPath + "m2 c5a\results m2 c5a 5lo561 cpla2 648\", 5, 5);
getPointsInCluster(rootPath + "m2 c5a\results m2 c5a 5lo561 cpla2 649\", 5, 5);
getPointsInCluster(rootPath + "m2 c5a\results m2 c5a 5lo561 cpla2 650\", 5, 5);


fprintf("c5a 5LO FLAP\n");

getPointsInCluster(rootPath + "m1 c5a\results c5a 5lo561 flap647 2\", 5, 10);
getPointsInCluster(rootPath + "m2 c5a\results m2 c5a 5lo561 flap647\", 5, 10);
getPointsInCluster(rootPath + "m2 c5a\results m2 c5a 5lo561 flap648\", 5, 10);
getPointsInCluster(rootPath + "m2 c5a\results m2 c5a 5lo561 flap649\", 5, 10);
getPointsInCluster(rootPath + "m3 c5a\c5a 5lo561 flap647\", 5, 10);
getPointsInCluster(rootPath + "m3 c5a\c5a 5lo561 flap648\", 5, 10);


fprintf("c5a cPLA2 FLAP");

getPointsInCluster(rootPath + "m1 c5a\results c5a flap647   cpla2561\", 5, 10);
getPointsInCluster(rootPath + "m1 c5a\results c5a flap647 cpla2561\", 5, 10);
getPointsInCluster(rootPath + "m2 c5a\results m2 c5a cpla2561 flap647\", 5, 10);


fprintf("GM c5a 5LO cPLA2\n");

getPointsInCluster(rootPath + "m1 gmc5a\results gmc5a 5lo561 cpla647\", 5, 5);
getPointsInCluster(rootPath + "m1 gmc5a\results gmc5a 5lo561 cpla651\", 5, 5);
getPointsInCluster(rootPath + "m1 gmc5a\results gmc5a 5lo561 cpla652\", 5, 5);
getPointsInCluster(rootPath + "m2 gmc5a\results m2 gmc5a 5lo561 cpla2 647\", 5, 5);
getPointsInCluster(rootPath + "m2 gmc5a\results m2 gmc5a 5lo561 cpla2 648\", 5, 5);
getPointsInCluster(rootPath + "m2 gmc5a\results m2 gmc5a 5lo561 cpla2 650\", 5, 5);
getPointsInCluster(rootPath + "m3 gmc5a\m3 gmc5a 5lo561 cpla2647 results\", 5, 5);
getPointsInCluster(rootPath + "m3 gmc5a\m3 gmc5a 5lo561 cpla2650 results\", 5, 5);
getPointsInCluster(rootPath + "m3 gmc5a\m3 gmc5a 5lo561 cpla2651 results\", 5, 5);


fprintf("GM c5a 5LO FLAP\n");

getPointsInCluster(rootPath + "m1 gmc5a\results gmc5a 5lo561 flap647\", 5, 10);
getPointsInCluster(rootPath + "m1 gmc5a\results gmc5a 5lo647 flap647\", 5, 10);
%getPointsInCluster(rootPath + "m2 gmc5a\results m2 gmc5a 5lo561 flap647\", 5, 10);
getPointsInCluster(rootPath + "m2 gmc5a\results m2 gmc5a 5lo561 flap648\", 5, 10);
getPointsInCluster(rootPath + "m2 gmc5a\results m2 gmc5a 5lo561 flap649\", 5, 10);
getPointsInCluster(rootPath + "m3 gmc5a\m3 gmc5a 5lo561 flap647 results\", 5, 10);
getPointsInCluster(rootPath + "m3 gmc5a\m3 gmc5a 5lo561 flap649 results\", 5, 10);


fprintf("GM c5a cPLA2 FLAP\n");
getPointsInCluster(rootPath + "m2 gmc5a\results m2 gmc5a cpla2561 flap648\", 5, 10);
getPointsInCluster(rootPath + "m2 gmc5a\results m2 gmc5a cpla2561 flap649\", 5, 10);
getPointsInCluster(rootPath + "m3 gmc5a\m3 gmc5a cpla2561 flap647 results\", 5, 10);
getPointsInCluster(rootPath + "m3 gmc5a\m3 gmc5a cpla2561 flap648 results\", 5, 10);
getPointsInCluster(rootPath + "m3 gmc5a\m3 gmc5a cpla2561 flap649 results\", 5, 10);
getPointsInCluster(rootPath + "m3 gmc5a\m3 gmc5a cpla2561 flap650 results\", 5, 10);
getPointsInCluster(rootPath + "m3 gmc5a\m3 gmc5a cpla2561 flap651 results\", 5, 10);
getPointsInCluster(rootPath + "m3 gmc5a\m3 gmc5a cpla2561 flap651a results\", 5, 10);


fprintf("unstim 5LO cPLA2\n");

getPointsInCluster(rootPath + "m1 unstim\results unstim 5lo561 cpla2647\", 5, 5);
getPointsInCluster(rootPath + "m1 unstim\results unstim 5lo561 cpla2648\", 5, 5);
getPointsInCluster(rootPath + "m1 unstim\results unstim 5lo561 cpla2649\", 5, 5);
getPointsInCluster(rootPath + "m2 unstim\results m2 unstim 5lo641 cpla2647\", 5, 5);
getPointsInCluster(rootPath + "m3 unstim\unstim 5lo651 cpla2647\", 5, 5);
getPointsInCluster(rootPath + "m4 unstim\m4 unstim 5lp561 cpla2647\", 5, 5);


fprintf("unstim 5LO FLAP\n");

getPointsInCluster(rootPath + "m1 unstim\results unstim 5lo561 flap647\", 5, 10);
getPointsInCluster(rootPath + "m2 unstim\results m2 unstim 5lo561 flap647\", 5, 10);
getPointsInCluster(rootPath + "m2 unstim\results m2 unstim 5lo561 flap648\", 5, 10);
getPointsInCluster(rootPath + "m2 unstim\results m2 unstim 5lo641 flap647\", 5, 10);
getPointsInCluster(rootPath + "m3 unstim\unstim 5lo651 flap648\", 5, 10);


fprintf("unstim cPLA2 FLAP\n");

getPointsInCluster(rootPath + "m3 unstim\unstim cpla2651 flap647\", 5, 10);
getPointsInCluster(rootPath + "m4 unstim\m4 unstim cpla2561 flap647\", 5, 10);
getPointsInCluster(rootPath + "m4 unstim\m4 unstim cpla2561 flap648\", 5, 10);



fprintf("area, density Ch1, density Ch2, number Ch1, number Ch2, clusters, fraction interacting in clusters Ch1, fraction interacting in clusters Ch2\n");
    
function getPointsInCluster(rootPath, clusterInThresholdCh1, clusterInThresholdCh2)
    clusterFileName = "Clus-DoC Results\DBSCAN Clus-DoC Results.mat";
    pointsFileName = "Clus-DoC Results\Data_for_Cluster_Analysis.mat";

    load(rootPath + clusterFileName);
    load(rootPath + pointsFileName);
    
    numROI = size(ClusterSmoothTableCh1, 1);
    
    synthesisCenters = cell([numROI 1]);
    
    for i = 1:numROI
        roiCh1 = ClusterSmoothTableCh1{i,1};
        roiCh2 = ClusterSmoothTableCh2{i,1};
        
        roiPointsData = Data_DoC{i,1};
        
        numClustersCh1 = size(roiCh1, 1);
        numClustersCh2 = size(roiCh2, 1);
        
        synthesisCentersCh1 = cell(0);
        synthesisCentersCh2 = cell(0);
        synthesisCenterCh1Count = 0;
        synthesisCenterCh2Count = 0;
        
        pointsCh1 = [roiPointsData.X(roiPointsData.Ch == 1) roiPointsData.Y(roiPointsData.Ch == 1)];
        pointsDoCCh1 = roiPointsData.DoC(roiPointsData.Ch == 1);
        pointsCh2 = [roiPointsData.X(roiPointsData.Ch == 2) roiPointsData.Y(roiPointsData.Ch == 2)];
        pointsDoCCh2 = roiPointsData.DoC(roiPointsData.Ch == 2);
                
        for j = 1:numClustersCh1
            cluster = roiCh1{j,1};

            % low interaction
%             if cluster.Nb < clusterInThresholdCh1 || (cluster.Nb_In == 0 || cluster.Nb_In > 5)
%                 continue;
%             end
            
            % no interaction
            if cluster.Nb < clusterInThresholdCh1 || cluster.Nb_In > 0
               continue;
            end
            
            % high interaction
%             if cluster.Nb < clusterInThresholdCh1 || cluster.Nb_In <= 5
%                continue;
%             end
            
            % cluster too small
%             if cluster.Nb >= clusterInThresholdCh1
%                 continue;
%             end
            
            inCluster = inpoly(pointsCh2, cluster.Contour);
            
            synthesisCenter.FoundingCh = 1;
            synthesisCenter.OriginalClusterID = cluster.ClusterID;
            synthesisCenter.PointsCh1 = cluster.Points;
            synthesisCenter.PointsCh2 = pointsCh2([inCluster inCluster]);
            synthesisCenter.Area = cluster.Area;
            synthesisCenter.NbCh1 = cluster.Nb;
            synthesisCenter.NbCh2 = nnz(inCluster);
            synthesisCenter.Nb_InCh1 = cluster.Nb_In;
            synthesisCenter.Nb_InCh2 = nnz(inCluster & pointsDoCCh2 > 0.4);
            synthesisCenter.Contour = cluster.Contour;
            
            xsize = ceil (max(cluster.Points(:,1)) - min(cluster.Points(:,1)));
            ysize = ceil (max(cluster.Points(:,2)) - min(cluster.Points(:,2)));
            
            synthesisCenter.TotalAreaDensityCh1 = cluster.TotalAreaDensity;
            synthesisCenter.TotalAreaDensityCh2 = synthesisCenter.NbCh2 / (xsize * ysize);
            
            pointNeighborsCh2 = rangesearch(synthesisCenter.PointsCh2, synthesisCenter.PointsCh2, 20);
            localDensityCh2 = cellfun('length', pointNeighborsCh2) / (pi * 20^2);
            
            synthesisCenter.AvRelativeDensity20Ch1 = cluster.AvRelativeDensity20;
            synthesisCenter.AvRelativeDensity20Ch2 = mean(localDensityCh2 / synthesisCenter.TotalAreaDensityCh2);
            if isnan(synthesisCenter.AvRelativeDensity20Ch2)
                synthesisCenter.AvRelativeDensity20Ch2 = 0;
            end
            
            synthesisCenterCh1Count = synthesisCenterCh1Count + 1;
            synthesisCentersCh1{synthesisCenterCh1Count} = synthesisCenter;
        end
        
        for j = 1:numClustersCh2
            cluster = roiCh2{j,1};
            
            % low interaction
%             if cluster.Nb < clusterInThresholdCh2 || (cluster.Nb_In == 0 || cluster.Nb_In > 5)
%                 continue;
%             end
            
            % no interaction
            if cluster.Nb < clusterInThresholdCh2 || cluster.Nb_In > 0
               continue;
            end
            
            % high interaction
%             if cluster.Nb < clusterInThresholdCh2 || cluster.Nb_In <= 5
%                continue;
%             end
            
            % cluster too small
%             if cluster.Nb >= clusterInThresholdCh2
%                 continue;
%             end
                     
            inCluster = inpoly(pointsCh1, cluster.Contour);
            
            synthesisCenter.FoundingCh = 2;
            synthesisCenter.OriginalClusterID = cluster.ClusterID;
            synthesisCenter.PointsCh1 = pointsCh1([inCluster inCluster]);
            synthesisCenter.PointsCh2 = cluster.Points;
            synthesisCenter.Area = cluster.Area;
            synthesisCenter.NbCh1 = nnz(inCluster);
            synthesisCenter.NbCh2 = cluster.Nb;
            synthesisCenter.Nb_InCh1 = nnz(inCluster & pointsDoCCh1 > 0.4);
            synthesisCenter.Nb_InCh2 = cluster.Nb_In;
            synthesisCenter.Contour = cluster.Contour;
            
            xsize = ceil (max(cluster.Points(:,1)) - min(cluster.Points(:,1)));
            ysize = ceil (max(cluster.Points(:,2)) - min(cluster.Points(:,2)));
            
            synthesisCenter.TotalAreaDensityCh1 = synthesisCenter.NbCh1 / (xsize * ysize);
            synthesisCenter.TotalAreaDensityCh2 = cluster.TotalAreaDensity;
            
            pointNeighborsCh1 = rangesearch(synthesisCenter.PointsCh1, synthesisCenter.PointsCh1, 20);
            localDensityCh1 = cellfun('length', pointNeighborsCh1) / pi * 20^2;
            
            synthesisCenter.AvRelativeDensity20Ch1 = mean(localDensityCh1 / synthesisCenter.TotalAreaDensityCh1);
            if isnan(synthesisCenter.AvRelativeDensity20Ch1)
                synthesisCenter.AvRelativeDensity20Ch1 = 0;
            end
            synthesisCenter.AvRelativeDensity20Ch2 = cluster.AvRelativeDensity20;
            
            synthesisCenterCh2Count = synthesisCenterCh2Count + 1;
            synthesisCentersCh2{synthesisCenterCh2Count} = synthesisCenter;
        end
        
        inClusters1 = zeros([numel(pointsDoCCh1) 1]);
        inClusters2 = zeros([numel(pointsDoCCh2) 1]);
        
        
%         overlapCount = 0;
%         
        for j = 1:synthesisCenterCh1Count
            points1 = synthesisCentersCh1{j}.PointsCh1;
            contour1 = synthesisCentersCh1{j}.Contour;
            
            % mark channel 1 points in channel 1 clusters
            for z = 1:size(points1, 1)
                pointIndex = pointsCh1(:,1) == points1(z,1) & pointsCh1(:,2) == points1(z,2);
                inClusters1(pointIndex) = true;
            end
            
            % mark channel 2 points in channel 1 clusters
            inClusterPoints2 = pointsCh2(inpoly(pointsCh2, contour1),:);
            for z = 1:size(inClusterPoints2, 1)
                pointIndex = pointsCh2(:,1) == inClusterPoints2(z,1) & pointsCh2(:,2) == inClusterPoints2(z,2);
                inClusters2(pointIndex) = true;
            end
         end
        
        for j = 1:synthesisCenterCh2Count
            points2 = synthesisCentersCh2{j}.PointsCh2;
            contour2 = synthesisCentersCh2{j}.Contour;
            
            % mark channel 2 points in channel 2 clusters
            for z = 1:size(points2, 1)
                pointIndex = pointsCh2(:,1) == points2(z,1) & pointsCh2(:,2) == points2(z,2);
                inClusters2(pointIndex) = true;
            end
            
            % mark channel 1 points in channel 2 clusters
            inClusterPoints1 = pointsCh1(inpoly(pointsCh1, contour2),:);
            for z = 1:size(inClusterPoints1, 1)
                pointIndex = pointsCh1(:,1) == inClusterPoints1(z,1) & pointsCh1(:,2) == inClusterPoints1(z,2);
                inClusters1(pointIndex) = true;
            end
         end
%         
%         
%         % check for overlapping clusters
%         for j = 1:synthesisCenterCh2Count
%             points2 = synthesisCentersCh2{j}.PointsCh2;
%             contour2 = synthesisCentersCh2{j}.Contour;
%                         
%             for k = 1:synthesisCenterCh1Count
%                 points1 = synthesisCentersCh1{k}.PointsCh1;
%                 contour1 = synthesisCentersCh1{k}.Contour;
%                 
%                 % mark channel 1 points in chanel 1 clusters
%                 for z = 1:size(points2, 1)
%                     pointIndex = pointsCh1(:,1) == points1(z,1) & pointsCh1(:,2) == points1(z,2);
%                     inClusters1(pointIndex) = true;
%                 end
%                 
%                 inCluster1 = inpoly(points1, contour2);
%                 inCluster2 = inpoly(points2, contour1);
%                 
%                 % mark channel 1 points in chanel 2 clusters
%                 for z = 1:size(points2, 1)
%                     inPoints1 = 
%                     pointIndex = pointsCh1(:,1) == points1(z,1) & pointsCh1(:,2) == points1(z,2);
%                     inClusters1(pointIndex) = true;
%                 end
%                 
%                 if any(inCluster1) || any(inCluster2)
%                     overlapCount = overlapCount + 1; 
%                 end
%             end
%         end
%         
%         % warn if overlapping clusters found (double counting potential)
%         if (overlapCount > 0)
%             fprintf("found %i overlap events for %i\n", overlapCount, i);
%         end
        
        roiSynthesisCenters = [synthesisCentersCh1 synthesisCentersCh2];
        
        
        totalCh1Points = numel(pointsDoCCh1);
        totalCh2Points = numel(pointsDoCCh2);
        
        totalCh1Interacting = nnz(pointsDoCCh1 > 0.4);
        totalCh2Interacting = nnz(pointsDoCCh2 > 0.4);
        totalCh1InteractingInClusters = nnz(pointsDoCCh1 > 0.4 & inClusters1);
        totalCh2InteractingInClusters = nnz(pointsDoCCh2 > 0.4 & inClusters2);
        fractionCh1Interacting = totalCh1Interacting / totalCh1Points;
        fractionCh2Interacting = totalCh2Interacting / totalCh2Points;
        
        if (isempty(roiSynthesisCenters))
            fprintf("No merged clusters found; total interacting (Ch1|Ch2): %i|%i, fraction interacting: %f|%f out of %i|%i\n", ...
                totalCh1Interacting, totalCh2Interacting, fractionCh1Interacting, fractionCh2Interacting, totalCh1Points, totalCh2Points);
            return;
        end
        
        fractionCh1InteractingInClusters = totalCh1InteractingInClusters / totalCh1Interacting;
        fractionCh2InteractingInClusters = totalCh2InteractingInClusters / totalCh2Interacting;
       
        
        synthesisCenters{i} = roiSynthesisCenters;
        
        area = mean(cellfun(@(x) x.Area, roiSynthesisCenters));
        numberCh1 = mean(cellfun(@(x) x.NbCh1, roiSynthesisCenters));
        numberCh2 = mean(cellfun(@(x) x.NbCh2, roiSynthesisCenters));
        densityCh1 = mean(cellfun(@(x) x.AvRelativeDensity20Ch1, roiSynthesisCenters));
        densityCh2 = mean(cellfun(@(x) x.AvRelativeDensity20Ch2, roiSynthesisCenters));
        clusterCount = length(roiSynthesisCenters);
        
        fprintf("%f, %f, %f, %f, %f, %i, %f, %f\n", ...
            area, densityCh1, densityCh2, numberCh1, numberCh2, clusterCount, fractionCh1InteractingInClusters, fractionCh2InteractingInClusters);
    end
end